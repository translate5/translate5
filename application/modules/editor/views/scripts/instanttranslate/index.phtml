<?php
/*
 START LICENSE AND COPYRIGHT
 
 This file is part of translate5
 
 Copyright (c) 2013 - 2017 Marc Mittag; MittagQI - Quality Informatics;  All rights reserved.
 
 Contact:  http://www.MittagQI.com/  /  service (ATT) MittagQI.com
 
 This file may be used under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE version 3
 as published by the Free Software Foundation and appearing in the file agpl3-license.txt
 included in the packaging of this file.  Please review the following information
 to ensure the GNU AFFERO GENERAL PUBLIC LICENSE version 3 requirements will be met:
 http://www.gnu.org/licenses/agpl.html
 
 There is a plugin exception available for use with this release of translate5 for
 translate5: Please see http://www.translate5.net/plugin-exception.txt or
 plugin-exception.txt in the root folder of translate5.
 
 @copyright  Marc Mittag, MittagQI - Quality Informatics
 @author     MittagQI - Quality Informatics
 @license    GNU AFFERO GENERAL PUBLIC LICENSE version 3 with plugin-execption
 http://www.gnu.org/licenses/agpl.html http://www.translate5.net/plugin-exception.txt
 
 END LICENSE AND COPYRIGHT
 */
?>

<?php
    // Which languages are available according to the LanguageResources?
    // (We only the need the single lists here, not in which combination they work.)
    // In order to save time we use this loop to calculate the characterLimit, too.
    $allCharacterLimits = array();
    $allSourceLanguageLocales = array();
    $allTargetLanguageLocales = array();
    
    foreach ($this->machineTranslationEngines as $languageResource) {
        $allCharacterLimits[] = $languageResource['characterLimit'];
        foreach ($languageResource['source'] as $sourceLocale) {
            if (!in_array($sourceLocale, $allSourceLanguageLocales)) {
                $allSourceLanguageLocales[] = $sourceLocale;
            }
        }
        foreach ($languageResource['target']as $key => $targetLocale) {
            if (!in_array($targetLocale, $allTargetLanguageLocales)) {
                $allTargetLanguageLocales[] = $targetLocale;
            }
        }
    }
    sort($allSourceLanguageLocales);
    sort($allTargetLanguageLocales);
    
    // the lowest number of characters that any of the LanguageResources can handle 
    // is our limit for what the user is allowed to enter:
    if(empty($allCharacterLimits)) {
        $characterLimit = 3;
    }
    else {
        $characterLimit = min($allCharacterLimits);
    }
    $translate = ZfExtended_Zendoverwrites_Translate::getInstance();
?>

<div class="loadingSpinnerLayer"><img src="<?php echo $this->publicModulePath; ?>/images/loading-spinner.gif"/></div>

<div id="containerHeader" class="container">
    <div id="logo"></div>
<?php 

    $userModel=ZfExtended_Factory::get('ZfExtended_Models_User');
    /* @var $userModel ZfExtended_Models_User */
    $isUserAllowed=$userModel->isAllowed("editor_termportal","all");
    
    //check if the user is allowed to acces the term portal
    if($isUserAllowed){
        echo '<div id="termPortal"><a class="ui-button ui-widget ui-corner-all">'.$translate->_("Terminologieportal").'</a></div>';
    }else{
        echo '<div id="termPortal"></div>';
    }
    
    // see View_Helper_LanguageSelector
    $session = new Zend_Session_Namespace();
    
    $availableTranslations = $translate->getAvailableTranslations();
    asort($availableTranslations);
    $languageSelector=[];
    
    //translated strings
    $this->translations=array(
        "clearText"                 => $translate->_("Text zurücksetzen"),
        "copy"                      => $translate->_("Kopieren"),
        "enterText"                 => $translate->_("Geben Sie Text ein"),
        "serverErrorMsg500"         => $translate->_("Die Anfrage führte zu einem Fehler im angefragten Dienst."),
        "noResultsFound"            => $translate->_("Es wurden keine Ergebnisse gefunden."),
        "translate"                 => $translate->_("Übersetzen"),
        "orTranslateFile"           => $translate->_("oder lassen Sie ein Dokument übersetzen"),
        "orTranslateText"           => $translate->_("oder lassen Sie Text übersetzen, den Sie eingeben."),
        "turnOffInstantTranslation" => $translate->_("Sofortübersetzung deaktivieren"),
        "turnOnInstantTranslation"  => $translate->_("Sofortübersetzung aktivieren"),
        "uploadFile"                => $translate->_("Laden Sie eine Datei hoch"),
        "uploadFileNotFound"        => $translate->_("Bitte wählen Sie eine Datei aus."),
        "pleaseChoose"              => $translate->_("Bitte auswählen"),
        "clearBothLists"            => $translate->_("Beide Listen zurücksetzen"),
        "showAllAvailableFor"       => $translate->_("Alle anzeigen für"),
        "notAllowed"                => $translate->_("nicht erlaubt"),
        "openInTermPortal"          => $translate->_("Term in Terminologie-Portal öffnen"),
        "attentionFuzzyMatch"       => $translate->_("Achtung! FuzzyMatch ({0})"),
        "differenceIsHighlighted"   => $translate->_("Quellsegment zum TM-Match: Unterschied zu Ihrer Texteingabe hervorgehoben"),
        "selectLanguages"           => $translate->_("Bitte wählen Sie eine Sprachkombination für die Übersetzung.")
    );
    $this->Php2JsVars()->set('languageresource.translatedStrings',$this->translations);
    
    $languageSelector[]='<form action="#" method="post" name="languageSelector" id="languageSelector">';
    $languageSelector[]='<select id="locale">';
    foreach ($availableTranslations as $locale => $translation) {
        $selected = ($locale == $session->locale) ? ' selected="selected"' : '';
        $languageSelector[]='<option value="'.$locale.'"'.$selected.'>'.$translation.'</option>';
    }
    $languageSelector[]='</select>';
    $languageSelector[]='</form>';
    echo implode(' ', $languageSelector);
?>
    <div id="logout"><a href="/login/logout" class="ui-button ui-widget ui-corner-all">Logout</a></div>
</div>

<div id="containerTranslation" class="container">
	<div id="source">
        <form id="sourceLanguageAndContent">
            <select id="sourceLocale" name="sourceLocale">
                <?php
                    $optionValues=[];
                    $optionValues[]='<option value="-">-</option>';
                    foreach ($allSourceLanguageLocales as $sourceLangLocale) {
                        $selected = ($sourceLangLocale== $this->sourceSearchLanguagePreselectionLocale) ? ' selected="selected"' : '';
                        $optionValues[]='<option value="'.$sourceLangLocale.'"'.$selected.'>'.$sourceLangLocale.'</option>';
                    }
                    echo implode(' ', $optionValues);
                ?>
            </select>
            <div id="sourceIsText" class="source-toggle show-if-source-is-text infotext"></div>
            <div id="sourceIsFile" class="source-toggle show-if-source-is-file infotext"></div>
            <div id="sourceContent" class="clearable">
                <textarea id="sourceText" name="sourceText" wrap="SOFT" class="show-if-source-is-text"></textarea> <!-- TODO: what to do with a lot of text (and after clearing)? Scrollbars? Resize?-->
                <span class="clearable-clear show-if-source-is-text" title="<?php echo $this->translations["clearText"];?>">&times;</span> <!-- TODO: (1) reposition after resizing the textarea by the user (2) interferes with scrollbars-->
                <span id="countedCharacters" class="show-if-source-is-text">0</span>
                <input id="sourceFile" name="sourceFile" type="file" class="show-if-source-is-file"/>
            </div>
        <div id="sourceError" class="instant-translation-error ui-state-error ui-corner-all"></div>
        </form>
    </div>
    <div id="target">
        <form id="targetControls">
            <select id="targetLocale" name="targetLocale">
                <?php
                    $optionValues=[];
                    $optionValues[]='<option value="-">-</option>';
                    foreach ($allTargetLanguageLocales as $targetLangLocale) {
                        $selected = ($targetLangLocale== $this->targetSearchLanguagePreselectionLocale) ? ' selected="selected"' : '';
                        $optionValues[]='<option value="'.$targetLangLocale.'"'.$selected.'>'.$targetLangLocale.'</option>';
                    }
                    echo implode(' ', $optionValues);
                ?>
            </select>
            <input id="translationSubmit" name="translationSubmit" value="<?php echo $this->translations["translate"];?>" type="submit" class="click-starts-translation ui-corner-all ui-button ui-widget"/>
            <div id="instantTranslationIsOff" class="click-starts-translation instant-translation-toggle infotext"><a href="#"><?php echo $this->translations["turnOnInstantTranslation"];?></a></div>
            <div id="instantTranslationIsOn" class="instant-translation-toggle infotext"><a href="#"><?php echo $this->translations["turnOffInstantTranslation"];?></a></div>
        </form>
        <div id="targetError" class="instant-translation-error ui-state-error ui-corner-all"></div>
        <div class="loadingSpinnerIndicator"><img src="<?php echo $this->publicModulePath; ?>/images/loading-spinner.gif"/></div>
        <div id="translations">
            <!-- inject translations here  -->
        </div>
    </div>
</div>

<script type="text/javascript">
    var allSourceLanguageLocales = '<?php echo json_encode($allSourceLanguageLocales);?>';
    allSourceLanguageLocales = JSON.parse(allSourceLanguageLocales);
    var allTargetLanguageLocales = '<?php echo json_encode($allTargetLanguageLocales);?>';
    allTargetLanguageLocales = JSON.parse(allTargetLanguageLocales);
    var allLanguageResources = '<?php echo json_encode($this->machineTranslationEngines);?>';
    allLanguageResources = JSON.parse(allLanguageResources);
    var characterLimit = '<?php echo $characterLimit;?>';
</script>

<script type="text/javascript">
$( function() {
    $('#locale').selectmenu({
        change: function() {
            var action = $(this).val();
            $("#languageSelector").attr("action", "?locale=" + action);
            $("#languageSelector").submit();
        }
      });
    $('#sourceLocale').selectmenu({
        change: function( event, ui ) {
            renderLocalesAsAvailable('accordingToSourceLocale');
        }
      }).selectmenu("menuWidget").addClass("overflow");
    $('#targetLocale').selectmenu({
        change: function( event, ui ) {
            renderLocalesAsAvailable('accordingToTargetLocale');
        }
      }).selectmenu("menuWidget").addClass("overflow");
    $('#sourceFile').button();
    $('#translationSubmit').button();
    $('#sourceContent').tooltip({
        position: { my: "left+15 center", at: "bottom", of: ".clearable-clear" }
    });
    $('#translations .translation-sourcediff').tooltip({
        position: { my: "left+15 center", at: "bottom", of: ".translation-sourcediff" }
    });
    $('#translations .copyable-copy').tooltip({
        position: { my: "left+15 center", at: "bottom", of: ".copyable-copy" }
    });
    $('#translations .term-info').tooltip({
        position: { my: "left+15 center", at: "bottom", of: ".term-info" }
    });
    $('#translations .term-status').tooltip({
        position: { my: "left+15 center", at: "bottom", of: ".term-info" }
    });
    // start with locales as stored for user
    if ($("#sourceLocale").val() !== '-') {
        renderLocalesAsAvailable('accordingToSourceLocale');
    } else if ($("#targetLocale").val() !== '-') {
        renderLocalesAsAvailable('accordingToTargetLocale');
    } else {
        renderLocalesAsAvailable('reset');
    }
    $("#sourceText").attr('maxlength',characterLimit);
    clearAllErrorMessages();
    setFileTypesAllowedAndAvailable();
    setTextForSource();
    showSource();
} );
</script>

<script src="<?php echo APPLICATION_RUNDIR; ?>/modules/editor/instanttranslate/js/Instanttranslate.js"></script>

<script type="text/javascript">
// "toggle" source (text/file)
$(document).on('click', '.source-toggle .change-source-type' , function() {
    $('.source-toggle').toggle();
    chosenSourceIsText = !chosenSourceIsText;
    clearAllErrorMessages();
    document.getElementById("sourceFile").value = "";
    showSource();
});
</script>

