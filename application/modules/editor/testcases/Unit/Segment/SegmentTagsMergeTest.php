<?php
/*
START LICENSE AND COPYRIGHT

 This file is part of translate5

 Copyright (c) 2013 - 2021 Marc Mittag; MittagQI - Quality Informatics;  All rights reserved.

 Contact:  http://www.MittagQI.com/  /  service (ATT) MittagQI.com

 This file may be used under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE version 3
 as published by the Free Software Foundation and appearing in the file agpl3-license.txt
 included in the packaging of this file.  Please review the following information
 to ensure the GNU AFFERO GENERAL PUBLIC LICENSE version 3 requirements will be met:
 http://www.gnu.org/licenses/agpl.html

 There is a plugin exception available for use with this release of translate5 for
 translate5: Please see http://www.translate5.net/plugin-exception.txt or
 plugin-exception.txt in the root folder of translate5.

 @copyright  Marc Mittag, MittagQI - Quality Informatics
 @author     MittagQI - Quality Informatics
 @license    GNU AFFERO GENERAL PUBLIC LICENSE version 3 with plugin-execption
             http://www.gnu.org/licenses/agpl.html http://www.translate5.net/plugin-exception.txt

END LICENSE AND COPYRIGHT
*/

namespace MittagQI\Translate5\Test\Unit\Segment;

use editor_Segment_FieldTags;
use MittagQI\Translate5\Test\SegmentTagsTestAbstract;

/**
 * Several PHPUnit tests to check the Tag-merging
 */
class SegmentTagsMergeTest extends SegmentTagsTestAbstract
{
    public function testTagMerging1(): void
    {
        $original = 'This is <ins1>Some </ins1><ins1>insertion</ins1> in a text';
        $expected = 'This is <ins1>Some insertion</ins1> in a text';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging2(): void
    {
        $original = 'This is <ins1>Some insertion</ins1><ins1> a </ins1><ins2>little longer</ins2> in a text';
        $expected = 'This is <ins1>Some insertion a </ins1><ins2>little longer</ins2> in a text';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging3(): void
    {
        $original = 'This is <ins1><1>Some </ins1><ins1>insertion</1></ins1> in a text';
        $expected = 'This is <ins1><1>Some insertion</1></ins1> in a text';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging4(): void
    {
        $original = 'This is <ins1><1>Some </ins1><ins1>insertion</1></ins1> in a text';
        $expected = 'This is <ins1><1>Some insertion</1></ins1> in a text';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging5(): void
    {
        $original = 'This is <ins1><1>Some </ins1><ins1>insertion</1></ins1> <ins1>in a text</ins1>';
        $expected = 'This is <ins1><1>Some insertion</1></ins1> <ins1>in a text</ins1>';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging6(): void
    {
        $original = 'This is <ins1><1>Some </ins1><ins1><3/>insertion</1></ins1> in a text';
        $expected = 'This is <ins1><1>Some <3/>insertion</1></ins1> in a text';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging7(): void
    {
        $original = 'This is <ins1><1>Some </ins1><ins1><3/>insertion</1></ins1><ins1> in a text</ins1>';
        $expected = 'This is <ins1><1>Some <3/>insertion</1> in a text</ins1>';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging8(): void
    {
        $original = 'This is <ins1><1><4/>Some </ins1><ins1><3/>insertion</1></ins1><ins1> <term1>in a text</term1></ins1>';
        $expected = 'This is <ins1><1><4/>Some <3/>insertion</1> <term1>in a text</term1></ins1>';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging9(): void
    {
        $original = '<ins1>This is</ins1> <ins1><1><4/>Some </ins1><ins1><3/>insertion</1></ins1><ins1> <term1>in a text</term1></ins1>';
        $expected = '<ins1>This is</ins1> <ins1><1><4/>Some <3/>insertion</1> <term1>in a text</term1></ins1>';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging10(): void
    {
        $original = '<ins3>Lorem <3/></ins3><ins3><4/></ins3>ipsum';
        $expected = '<ins3>Lorem <3/><4/></ins3>ipsum';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging11(): void
    {
        $original = '<ins3>Lorem <3/></ins3><ins3><5/><4/></ins3>ipsum';
        $expected = '<ins3>Lorem <3/><5/><4/></ins3>ipsum';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging12(): void
    {
        // The inbetween <ins> must prevent the merging of the first/third <ins> !
        $original = '<ins3>Lorem <3/></ins3><ins1><5/></ins1><ins3><4/></ins3>ipsum';
        $expected = '<ins3>Lorem <3/></ins3><ins1><5/></ins1><ins3><4/></ins3>ipsum';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging13(): void
    {
        //  The inbetween <5/> must prevent the merging of the first/third <ins> !
        $original = '<ins3>Lorem <3/></ins3><5/><ins3><4/></ins3>ipsum';
        $expected = '<ins3>Lorem <3/></ins3><5/><ins3><4/></ins3>ipsum';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testTagMerging14(): void
    {
        $original = '<del1>(<1><1><1>5*) Lorem Ipsum</1></1></del1><ins1>(5*) dolor sit amet <div class="term admittedTerm exact" title="" data-tbxid="id6ad172a1-e050-4783-87b9-2b3c6cd39712">cerniera</div> evedunt</ins1><ins2><1></ins2>5*) dolor sit amet <div class="term admittedTerm exact" title="" data-tbxid="id6ad172a1-e050-4783-87b9-2b3c6cd39712">cerniera</div> evedunt<ins3></1></ins3><del2>5</del2><del3>*) </del3><del2>dolor sit amet cerniera evedunt</del2><del3></1></del3><del2>5*) dolor sit amet cerniera evedunt</del2>';
        $expected = '<del1>(<1><1><1>5*) Lorem Ipsum</1></1></del><ins1>(5*) dolor sit amet <div class="term admittedTerm exact" title="" data-tbxid="id6ad172a1-e050-4783-87b9-2b3c6cd39712">cerniera</div> evedunt</ins><ins2><1></ins>5*) dolor sit amet <div class="term admittedTerm exact" title="" data-tbxid="id6ad172a1-e050-4783-87b9-2b3c6cd39712">cerniera</div> evedunt<ins3></1></ins3><del2>5</del2><del3>*) </del3><del2>dolor sit amet cerniera evedunt</del2><del3></1></del3><del2>5*) dolor sit amet cerniera evedunt</del2>';
        $this->createShortTagsMergingTest($original, $expected);
    }

    public function testRealDataTagmerging1(): void
    {
        $original = '<div class="single 70682069643d2231223e266c743b73796d2667743bee80a3266c743b2f73796d2667743b3c2f7068 internal-tag ownttip"><span class="short" title="&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;">&lt;1/&gt;</span><span class="full" data-originalid="ph" data-length="-1">&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;</span></div>Ichbin<ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1">einTerm </ins><ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1">Ichbin</ins>einTerm';
        $expected = '<div class="single 70682069643d2231223e266c743b73796d2667743bee80a3266c743b2f73796d2667743b3c2f7068 internal-tag ownttip"><span class="short" title="&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;">&lt;1/&gt;</span><span class="full" data-originalid="ph" data-length="-1">&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;</span></div>Ichbin<ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1">einTerm Ichbin</ins>einTerm';
        $this->createMergingTest($original, $expected);
    }

    public function testRealDataTagmerging2(): void
    {
        $original = '<div class="single 70682069643d2231223e266c743b73796d2667743bee80a3266c743b2f73796d2667743b3c2f7068 internal-tag ownttip"><span class="short" title="&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;">&lt;1/&gt;</span><span class="full" data-originalid="ph" data-length="-1">&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;</span></div><div title="" class="term preferredTerm exact" data-tbxid="889df480-8788-4945-8e76-5082137db6b4">Ichbin<ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00">einTerm</ins></div><ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00"> </ins><div title="" class="term preferredTerm exact" data-tbxid="889df480-8788-4945-8e76-5082137db6b4"><ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00">Ichbin</ins>einTerm</div>';
        $expected = '<div class="single 70682069643d2231223e266c743b73796d2667743bee80a3266c743b2f73796d2667743b3c2f7068 internal-tag ownttip"><span class="short" title="&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;">&lt;1/&gt;</span><span class="full" data-originalid="ph" data-length="-1">&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;</span></div>Ichbin<ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00">einTerm Ichbin</ins>einTerm';
        $this->createMergingTest($original, $expected, true);
    }

    public function testRealDataTagmerging3(): void
    {
        $original = '<div class="single 70682069643d2231223e266c743b73796d2667743bee80a3266c743b2f73796d2667743b3c2f7068 internal-tag ownttip"><span class="short" title="&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;">&lt;1/&gt;</span><span class="full" data-originalid="ph" data-length="-1">&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;</span></div><ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00">Ichbin </ins><div class="term preferredTerm exact" title="" data-tbxid="e280ca36-5448-4044-b3d9-1802e7fe460f"><ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00">keinTerm</ins> </div><ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00"><div class="term preferredTerm exact" title="" data-tbxid="e280ca36-5448-4044-b3d9-1802e7fe460f">Ichbin</div> keinTerm</ins>x';
        $expected = '<div class="single 70682069643d2231223e266c743b73796d2667743bee80a3266c743b2f73796d2667743b3c2f7068 internal-tag ownttip"><span class="short" title="&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;">&lt;1/&gt;</span><span class="full" data-originalid="ph" data-length="-1">&lt;ph id=&quot;1&quot;&gt;&amp;lt;sym&amp;gt;&amp;lt;/sym&amp;gt;&lt;/ph&gt;</span></div><ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00">Ichbin keinTerm</ins> <ins class="trackchanges ownttip" data-userguid="{00000000-0000-0000-C100-CCDDEE000002}" data-username="lector test" data-usercssnr="usernr2" data-workflowstep="reviewing1" data-timestamp="2018-11-20T10:38:16+01:00"><div class="term preferredTerm exact" title="" data-tbxid="e280ca36-5448-4044-b3d9-1802e7fe460f">Ichbin</div> keinTerm</ins>x';
        $this->createMergingTest($original, $expected, true);
    }

    public function testRealDataTagmerging4(): void
    {
        $original = '<del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-16T09:56:52+01:00">2 porte, parete posteriore<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;1/&gt;: Newline">&lt;1/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>incastonata davanti al centro<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;2/&gt;: Newline">&lt;2/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>Ripiani in metallo di 8 cm di profondit\u00e0 per le spezie<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;3/&gt;: Newline">&lt;3/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>1 ripiano regolabile a sinistra e 1 ripiano regolabile a destra<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;4/&gt;: Newline">&lt;4/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><ins class="trackchanges ownttip" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-16T09:56:52+01:00">2 ante, parete posteriore</ins><ins class="trackchanges ownttip" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T15:01:54+01:00"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;17/&gt;: Newline">&lt;17/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></ins><ins class="trackchanges ownttip" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-16T09:56:52+01:00">sporgente al centro<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;3/&gt;: Newline">&lt;3/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>Ripiani in metallo profondit\u00e0<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;4/&gt;: Newline">&lt;4/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>8 cm per spezie<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;5/&gt;: Newline">&lt;5/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>Risp. 1 ripiano interno<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;6/&gt;: Newline">&lt;6/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>regolabile sinistra e destra</ins><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T15:01:48+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:18:22+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:07:28+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:05:47+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:01:41+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:00:18+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:56:56+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:56:19+01:00" data-historylist="1770292454000" data-action_history_1770292454000="INS" data-usertrackingid_history_1770292454000="860"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;16/&gt;: Newline">&lt;16/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:56:16+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:54:07+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:52:05+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:13+01:00" data-historylist="1770277749000" data-action_history_1770277749000="INS" data-usertrackingid_history_1770277749000="801"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;15/&gt;: Newline">&lt;15/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:12+01:00">s</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:11+01:00">porg</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:10+01:00">ente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="801" data-usercssnr="usernr5" data-workflowstep="reviewing2" data-timestamp="2026-02-05T08:48:55+01:00" data-historylist="1770271878000" data-action_history_1770271878000="INS" data-usertrackingid_history_1770271878000="450"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;14/&gt;: Newline">&lt;14/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="801" data-usercssnr="usernr5" data-workflowstep="reviewing2" data-timestamp="2026-02-05T08:48:54+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-05T07:11:23+01:00" data-historylist="1770133006000" data-action_history_1770133006000="INS" data-usertrackingid_history_1770133006000="503"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;13/&gt;: Newline">&lt;13/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-05T07:11:23+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:36:22+01:00">s</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:36:21+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:29:24+01:00" data-historylist="1770117705000" data-action_history_1770117705000="INS" data-usertrackingid_history_1770117705000="450"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;12/&gt;: Newline">&lt;12/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:29:24+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:21:51+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:17:51+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:17:00+01:00" data-historylist="1769757288000" data-action_history_1769757288000="INS" data-usertrackingid_history_1769757288000="503"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;9/&gt;: Newline">&lt;9/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:16:57+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-30T08:14:53+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-29T15:22:44+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del>';
        $expected = '<del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-16T09:56:52+01:00">2 porte, parete posteriore<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;1/&gt;: Newline">&lt;1/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>incastonata davanti al centro<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;2/&gt;: Newline">&lt;2/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>Ripiani in metallo di 8 cm di profondit\u00e0 per le spezie<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;3/&gt;: Newline">&lt;3/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>1 ripiano regolabile a sinistra e 1 ripiano regolabile a destra<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;4/&gt;: Newline">&lt;4/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><ins class="trackchanges ownttip" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-16T09:56:52+01:00">2 ante, parete posteriore</ins><ins class="trackchanges ownttip" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T15:01:54+01:00"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;17/&gt;: Newline">&lt;17/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></ins><ins class="trackchanges ownttip" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-16T09:56:52+01:00">sporgente al centro<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;3/&gt;: Newline">&lt;3/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>Ripiani in metallo profondit\u00e0<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;4/&gt;: Newline">&lt;4/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>8 cm per spezie<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;5/&gt;: Newline">&lt;5/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>Risp. 1 ripiano interno<div class="single 736f667452657475726e2f newline internal-tag ownttip"><span class="short" title="&lt;6/&gt;: Newline">&lt;6/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div>regolabile sinistra e destra</ins><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T15:01:48+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:18:22+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:07:28+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:05:47+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:01:41+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T13:00:18+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:56:56+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:56:19+01:00" data-historylist="1770292454000" data-action_history_1770292454000="INS" data-usertrackingid_history_1770292454000="860"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;16/&gt;: Newline">&lt;16/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="881" data-usercssnr="usernr2" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:56:16+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:54:07+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:52:05+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:13+01:00" data-historylist="1770277749000" data-action_history_1770277749000="INS" data-usertrackingid_history_1770277749000="801"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;15/&gt;: Newline">&lt;15/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:12+01:00">s</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:11+01:00">porg</del><del class="trackchanges ownttip deleted" data-usertrackingid="860" data-usercssnr="usernr1" data-workflowstep="firsttranslation1" data-timestamp="2026-02-05T12:51:10+01:00">ente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="801" data-usercssnr="usernr5" data-workflowstep="reviewing2" data-timestamp="2026-02-05T08:48:55+01:00" data-historylist="1770271878000" data-action_history_1770271878000="INS" data-usertrackingid_history_1770271878000="450"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;14/&gt;: Newline">&lt;14/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="801" data-usercssnr="usernr5" data-workflowstep="reviewing2" data-timestamp="2026-02-05T08:48:54+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-05T07:11:23+01:00" data-historylist="1770133006000" data-action_history_1770133006000="INS" data-usertrackingid_history_1770133006000="503"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;13/&gt;: Newline">&lt;13/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-05T07:11:23+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:36:22+01:00">s</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:36:21+01:00">porgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:29:24+01:00" data-historylist="1770117705000" data-action_history_1770117705000="INS" data-usertrackingid_history_1770117705000="450"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;12/&gt;: Newline">&lt;12/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-02-03T16:29:24+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:21:51+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:17:51+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:17:00+01:00" data-historylist="1769757288000" data-action_history_1769757288000="INS" data-usertrackingid_history_1769757288000="503"><div class="single 736f667452657475726e2f newline whitespace internal-tag ownttip"><span class="short" title="&lt;9/&gt;: Newline">&lt;9/&gt;</span><span class="full" data-originalid="softReturn" data-length="1">\u21b5</span></div></del><del class="trackchanges ownttip deleted" data-usertrackingid="450" data-usercssnr="usernr2" data-workflowstep="translation1" data-timestamp="2026-02-03T12:16:57+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-30T08:14:53+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del><del class="trackchanges ownttip deleted" data-usertrackingid="503" data-usercssnr="usernr3" data-workflowstep="translation1" data-timestamp="2026-01-29T15:22:44+01:00">sporgente al centroRipiani in metallo profondit\u00e08 cm per spezieRisp. 1 ripiano internoregolabile sinistra e destra</del>';
        $this->createMergingTest($original, $expected, false);
    }

    protected function createShortTagsMergingTest(string $original, string $expected, bool $cleanTerms = false): void
    {
        $original = $this->shortToFull($original);
        $expected = $this->shortToFull($expected);
        $segmentId = rand(111111, 999999);
        $tags = new editor_Segment_FieldTags($this->getTestTask(), $segmentId, $original, 'target', 'targetEdit');
        if ($cleanTerms) {
            $tags->fixTermTaggerTags();
        }
        // to make error-catching easier we assign comparing the reverted tags
        $this->assertEquals($this->fullToShort($expected), $this->fullToShort($tags->render()));
        $this->createTagsTest($tags, $expected);
    }

    protected function createMergingTest(string $original, string $expected, bool $cleanTerms = false): void
    {
        $segmentId = rand(111111, 999999);
        $tags = new editor_Segment_FieldTags($this->getTestTask(), $segmentId, $original, 'target', 'targetEdit');
        if ($cleanTerms) {
            $tags->fixTermTaggerTags();
        }
        $this->createTagsTest($tags, $expected);
    }
}
