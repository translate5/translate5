/*
 * File: app/view/customer/Panel.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Erp.view.customer.Panel', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.customerpanel',

    requires: [
        'Erp.view.customer.PanelViewModel',
        'Erp.view.customer.PanelViewController',
        'Ext.grid.Panel',
        'Ext.grid.filters.filter.String',
        'Ext.grid.filters.filter.List',
        'Ext.grid.column.Number',
        'Ext.grid.filters.filter.Number',
        'Ext.selection.RowModel',
        'Ext.grid.filters.Filters',
        'Ext.view.Table',
        'Ext.form.Panel',
        'Ext.form.field.ComboBox',
        'Ext.button.Button',
        'Ext.toolbar.Toolbar'
    ],

    controller: 'customerpanel',
    viewModel: {
        type: 'customerpanel'
    },
    listeners: {
        activate: {
            fn: 'reloadCustomerStore',//when customers panel is displayed,this function is executed in the ViewController
            scope: 'controller'
        },
        render:{
            fn:'onCustomerPanelRender',
            scope:'controller'
        }
    },
    shrinkWrap: 0,
    layout: 'border',
    collapsed: false,
    title: 'My Panel',
    defaultListenerScope: true,
    defaultButton: 'saveButton',
    referenceHolder: true,
    dockedItems: [
        {
            xtype: 'toolbar',
            dock: 'top',
            items: [
                {
                    xtype: 'button',
                    iconCls: 'icon-add',
                    text: 'Hinzufügen',
                    listeners: {
                        click: {
                            fn: 'add',
                            scope: 'controller'
                        }
                    }
                },
                {
                    xtype: 'button',
                    iconCls: 'icon-refresh',
                    text: 'Aktualisieren',
                    listeners: {
                        click: {
                            fn: 'refresh',
                            scope: 'controller'
                        }
                    }
                },
                {
                    xtype: 'tbseparator'
                },
                {
                    xtype: 'button',
                    text: 'Sortierung / Filterung zurücksetzen',
                    listeners: {
                        click: {
                            fn: 'clearFilterAndSort',
                            scope: 'controller'
                        }
                    }
                }
            ]
        }
    ],

    initConfig: function(instanceConfig) {
        var me = this,
            config = {
                items: [
                    {
                        xtype: 'gridpanel',
                        flex: 1,
                        region: 'center',
                        split: true,
                        reference: 'list',
                        resizable: false,
                        title: '',
                        forceFit: true,
                        bind: {
                            store: '{customers}'
                        },
                        columns: [
                            {
                                xtype: 'gridcolumn',
                                dataIndex: 'name',
                                text: 'Kundenname',
                                filter: {
                                    type: 'string'
                                }
                            },
                            {
                                xtype: 'gridcolumn',
                                dataIndex: 'number',
                                text: 'Kundennummer',
                                filter: {
                                    type: 'string'
                                }
                            },
                            {
                                xtype: 'gridcolumn',
                                renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                    var store = me.getViewModel().getStore('keyaccounts'),
                                        keyaccount = store.getById(value);
                                    if(keyaccount && value>0) {
                                        return keyaccount.get('name');
                                    }
                                    return '';
                                },
                                dataIndex: 'keyaccount',
                                text: 'Keyaccount',
                                filter: me.processMyListFilter({
                                    type: 'list',
                                    labelField: 'name'
                                })
                            },
                            {
                                xtype: 'numbercolumn',
                                dataIndex: 'taxPercent',
                                text: 'Steuersatz',
                                align:'right',
                                filter: {
                                    type: 'number'
                                }
                            }
                        ],
                        listeners: {
                            itemdblclick: {
                                fn: 'dblclick',
                                scope: 'controller'
                            }
                        },
                        selModel: {
                            selType: 'rowmodel'
                        },
                        plugins: [
                            {
                                ptype: 'gridfilters'
                            }
                        ],
                        viewConfig: {
                            listeners: {
                                beforerefresh: 'onViewBeforeRefresh'
                            }
                        }
                    },
                    {
                        xtype: 'panel',
                        flex: 1,
                        region: 'east',
                        split: true,
                        reference: 'display',
                        width: 150,
                        layout: 'card',
                        bodyBorder: true,
                        items: [
                            {
                                xtype: 'form',
                                reference: 'form',
                                bodyPadding: 10,
                                fieldDefaults: {
                                    anchor: '1'
                                },
                                bind: {
                                    disabled: '{!record}',
                                    title: '{title}'
                                },
                                items: [
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: 'Kundenname',
                                        name: 'name',
                                        allowBlank: false,
                                        maxLength: 255,
                                        minLength: 3
                                    },
                                    {
                                        xtype: 'textfield',
                                        fieldLabel: 'Kundennummer',
                                        name: 'number',
                                        allowBlank: false,
                                        maxLength: 255,
                                        minLength: 3
                                    },
                                    {
                                        xtype: 'combobox',
                                        fieldLabel: 'Keyaccount',
                                        name: 'keyaccount',
                                        editable: false,
                                        displayField: 'name',
                                        forceSelection: true,
                                        queryMode: 'local',
                                        valueField: 'id',
                                        bind:{
                                            store:'{keyaccounts}'
                                        }
                                    },
                                    {
                                        xtype: 'combobox',
                                        fieldLabel: 'Steuersatz',
                                        name: 'taxPercent',
                                        allowBlank: false,
                                        editable: false,
                                        forceSelection: true,
                                        valueField: 'id',
                                        bind: {
                                            store: '{taxsets}'
                                        }
                                    },
                                    {
                                        xtype: 'container',
                                        padding: 10,
                                        layout: {
                                            type: 'hbox',
                                            align: 'middle',
                                            pack: 'center'
                                        },
                                        items: [
                                            {
                                                xtype: 'button',
                                                flex: 1,
                                                formBind: true,
                                                itemId: 'saveButton',
                                                reference: 'saveButton',
                                                margin: 5,
                                                text: 'Speichern',
                                                listeners: {
                                                    click: {
                                                        fn: 'save',
                                                        scope: 'controller'
                                                    }
                                                }
                                            },
                                            {
                                                xtype: 'button',
                                                flex: 1,
                                                itemId: 'cancelButton',
                                                margin: 5,
                                                text: 'Abbrechen',
                                                listeners: {
                                                    click: {
                                                        fn: 'cancelEdit',
                                                        scope: 'controller'
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            };
        if (instanceConfig) {
            me.self.getConfigurator().merge(me, config, instanceConfig);
        }
        return me.callParent([config]);
    },
    initComponent: function() {
        var me = this;
        me.callParent(arguments);
        //this will enable the store to be loaded when onFilterEndUpdate is called,it is disabled on store configuration
        me.getViewModel().getStore('customers').suppressNextFilter = false;
    },
    processMyListFilter: function(config) {
        config.options = Erp.data.customers.keyaccounts;
        return config;
    },
    
    onViewBeforeRefresh: function(dataview, eOpts) {
        //workaround / fix for TMUE-11
        dataview.getSelectionModel().deselectAll();
    }

});