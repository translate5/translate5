image: atlassian/default-image:2

options:
    docker: true

definitions:
    services:
        docker:
            memory: 3072

pipelines:
    custom:
        test:
          - variables:
              - name: GIT_BRANCH_BASE
                default: develop
                allowed-values:
                 - develop
                 - master
          - step:
                  script:
                      - export APP_HOST=localhost
                      - export MYSQL_USERNAME=translate5
                      - export MYSQL_PASSWORD=translate5
                      - export MYSQL_DATABASE=translate5
                      - export MYSQL_ROOT_PASSWORD=r00t
                      - export MYSQL_PORT=3306
                      - export MESSAGEBUS_HOST=frontendmessagebus
                      - export MESSAGEBUS_PORT=9057
                      - export LANGUAGETOOL_HOST=languagetool
                      - export GIT_BRANCH=$BITBUCKET_BRANCH
                      #- export GIT_TOKEN=$GIT_TOKEN_MAINTENANCE
                      - echo "Branch is $GIT_BRANCH, base branch is $GIT_BRANCH_BASE"
                      - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
                      - git clone https://bitbucket.org/mittagqi/docker.git .
                      #- docker-compose -f docker-compose.runtests.yml up --exit-code-from php
